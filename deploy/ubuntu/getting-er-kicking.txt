# Getting Magic Page Running on Ubuntu (Port 3000)

Quick reference for troubleshooting and getting the app running after deployment.

## Common Issues Encountered

### 1. Missing Dependencies
The package.json was missing some required dependencies that caused build/runtime failures.

**Fixed by adding:**
- `cookie` package (for webhookListener.js)
- `express` package (for server.js)

**Solution:**
```bash
npm install cookie express
npm install  # Install all dependencies
```

### 2. Multiple PM2 Instances Running
Running `pm2 start` multiple times creates multiple instances, all fighting for the same ports.

**Symptoms:**
- PM2 shows multiple instances (id 0, 1, 2, 3...)
- Error: EADDRINUSE: address already in use :::80
- Error: EADDRINUSE: address already in use :::443

**Solution:**
```bash
# Delete ALL instances
pm2 delete all

# Verify they're gone
pm2 status

# Start fresh with ONE instance
pm2 start npm --name "magic-page" -- run dev
```

### 3. Port 443/80 Conflicts (Production Server)
The production server (server.js) tries to bind to ports 80 and 443, which:
- Requires root/sudo privileges
- May conflict with other services
- Needs SSL certificates to work

**Solution: Use Port 3000 Instead**
```bash
# Use dev mode which runs on port 3000 (HTTP, no SSL needed)
pm2 delete all
pm2 start npm --name "magic-page" -- run dev
```

### 4. Old Domain Configuration (hlyfk.com)
The .env.local had old domain settings from previous installation.

**Solution:**
```bash
nano .env.local

# Update these lines:
DOMAIN=mp.membies.com
NEXT_PUBLIC_DOMAIN=mp.membies.com

# Save: Ctrl+X, Y, Enter
```

---

## Step-by-Step: Getting It Running on Port 3000

### Step 1: Clean Up PM2
```bash
cd ~/magicker-page

# Stop and delete all PM2 processes
pm2 delete all

# Verify nothing is running
pm2 status
```

### Step 2: Install Missing Dependencies
```bash
# Make sure all dependencies are installed
npm install

# Specifically install the ones that were missing
npm install cookie express
```

### Step 3: Update Environment Configuration
```bash
# Edit .env.local
nano .env.local

# Make sure these are set correctly:
DOMAIN=mp.membies.com
NEXT_PUBLIC_DOMAIN=mp.membies.com

# SSL paths aren't needed for port 3000, but if present should be:
# SSL_KEY_PATH="/etc/ssl/magic-page/privkey.pem"
# SSL_CERT_PATH="/etc/ssl/magic-page/fullchain.pem"

# Save and exit
```

### Step 4: Verify Docker Services
```bash
# Check PostgreSQL and other services are running
docker compose ps

# Should show:
# - botpress_postgres (Up)
# - botpress (Up)
# - botpress_duckling (Up)

# If not running:
docker compose up -d
```

### Step 5: Start App on Port 3000
```bash
# Start in development mode (port 3000)
pm2 start npm --name "magic-page" -- run dev

# Check status
pm2 status

# Should show ONE instance:
# │ 0  │ magic-page  │ fork  │ 0  │ online  │ 0%  │ 50mb  │
```

### Step 6: Verify It's Running
```bash
# Check logs
pm2 logs magic-page --lines 20

# Should see:
# > Ready on http://localhost:3000

# Test locally
curl http://localhost:3000

# Should return HTML
```

### Step 7: Open Firewall Port
```bash
# Allow port 3000
sudo ufw allow 3000/tcp

# Verify
sudo ufw status
```

### Step 8: Access from Browser
```
http://mp.membies.com:3000
```

---

## Useful PM2 Commands

**View logs in real-time:**
```bash
pm2 logs magic-page
```

**View last 50 lines:**
```bash
pm2 logs magic-page --lines 50
```

**Restart app:**
```bash
pm2 restart magic-page
```

**Stop app:**
```bash
pm2 stop magic-page
```

**Delete app:**
```bash
pm2 delete magic-page
```

**View status:**
```bash
pm2 status
```

**View resource usage:**
```bash
pm2 monit
```

**Clear logs:**
```bash
pm2 flush
```

---

## Log File Locations

**PM2 logs stored in:**
```bash
/root/.pm2/logs/magic-page-out.log    # Standard output
/root/.pm2/logs/magic-page-error.log  # Error output
```

**Tail logs directly:**
```bash
# Output log
tail -f /root/.pm2/logs/magic-page-out.log

# Error log
tail -f /root/.pm2/logs/magic-page-error.log

# Both at once
tail -f /root/.pm2/logs/magic-page-*.log
```

---

## Quick Troubleshooting

**App won't start:**
```bash
# Check logs for errors
pm2 logs magic-page --lines 100

# Common issues:
# - Missing dependencies: npm install
# - Port already in use: pm2 delete all
# - Database not running: docker compose up -d
```

**Port already in use:**
```bash
# See what's using port 3000
sudo lsof -i :3000

# Kill process if needed
sudo lsof -ti:3000 | xargs sudo kill -9

# Restart app
pm2 restart magic-page
```

**Multiple instances running:**
```bash
# Delete all and start fresh
pm2 delete all
pm2 start npm --name "magic-page" -- run dev
```

**Need to update code:**
```bash
# Pull latest changes
git pull

# Install any new dependencies
npm install

# Restart app
pm2 restart magic-page
```

---

## Production Server vs Dev Server

**Dev Server (Port 3000):**
- Command: `pm2 start npm --name "magic-page" -- run dev`
- Port: 3000 (HTTP)
- No SSL needed
- Hot reload enabled
- Easier to debug
- **Currently using this**

**Production Server (Ports 80/443):**
- Command: `pm2 start npm --name "magic-page" -- start`
- Ports: 80 (HTTP redirect) and 443 (HTTPS)
- Requires SSL certificates
- Requires root for port 443
- Optimized build
- **Not currently working due to SSL setup**

---

## To Switch to Production Server Later

Once DNS is propagated and you have SSL certificates:

1. **Get Let's Encrypt certificate:**
```bash
sudo certbot certonly --standalone -d mp.membies.com
```

2. **Update .env.local:**
```env
SSL_KEY_PATH="/etc/letsencrypt/live/mp.membies.com/privkey.pem"
SSL_CERT_PATH="/etc/letsencrypt/live/mp.membies.com/fullchain.pem"
```

3. **Build and start production:**
```bash
pm2 delete magic-page
npm run build
pm2 start npm --name "magic-page" -- start
```

4. **Access on standard ports:**
```
https://mp.membies.com
```

---

## Current Working Configuration

**App:** Running on port 3000 (dev mode)
**Access:** http://mp.membies.com:3000
**PM2:** Single instance
**Docker:** PostgreSQL, Botpress, Duckling running
**Domain:** mp.membies.com
**SSL:** Not configured (not needed for port 3000)

---

## Next Steps

1. ✅ App running on port 3000
2. ⏳ Wait for DNS propagation for mp.membies.com
3. ⏳ Get SSL certificate with certbot
4. ⏳ Switch to production server (ports 80/443)
5. ⏳ Set up PM2 to start on boot: `pm2 startup`
6. ⏳ Save PM2 configuration: `pm2 save`
7. ⏳ Set up automated backups
8. ⏳ Configure monitoring

---

**Last Updated:** 2025-11-24
**Server:** Vultr Ubuntu 22.04
**User:** root
**Working Directory:** /root/magicker-page
**Node Version:** v20.19.5
